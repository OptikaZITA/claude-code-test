{
  "name": "Eyekido - Medical Report ‚Üí Encrypted PDF ‚Üí Email to Parent",
  "nodes": [
    {
      "parameters": {
        "pollTimes": {
          "item": [
            {
              "mode": "everyMinute"
            }
          ]
        },
        "triggerOn": "specificFolder",
        "folderToWatch": {
          "__rl": true,
          "mode": "list",
          "value": ""
        },
        "event": "fileCreated",
        "options": {}
      },
      "id": "a1b2c3d4-0001-4000-8000-000000000001",
      "name": "Google Drive Trigger",
      "type": "n8n-nodes-base.googleDriveTrigger",
      "typeVersion": 1,
      "position": [0, 300],
      "credentials": {
        "googleDriveOAuth2Api": {
          "id": "",
          "name": "Google Drive - Eyekido"
        }
      }
    },
    {
      "parameters": {
        "operation": "download",
        "fileId": {
          "__rl": true,
          "mode": "id",
          "value": "={{ $json.id }}"
        },
        "options": {}
      },
      "id": "a1b2c3d4-0002-4000-8000-000000000002",
      "name": "Google Drive - Download PDF",
      "type": "n8n-nodes-base.googleDrive",
      "typeVersion": 3,
      "position": [260, 300],
      "credentials": {
        "googleDriveOAuth2Api": {
          "id": "",
          "name": "Google Drive - Eyekido"
        }
      }
    },
    {
      "parameters": {
        "operation": "pdf",
        "options": {}
      },
      "id": "a1b2c3d4-0003-4000-8000-000000000003",
      "name": "Extract From File",
      "type": "n8n-nodes-base.extractFromFile",
      "typeVersion": 1,
      "position": [520, 300]
    },
    {
      "parameters": {
        "jsCode": "// Build Anthropic API request body safely\nconst text = $input.first().json.text || '';\n\nconst requestBody = {\n  model: 'claude-sonnet-4-20250514',\n  max_tokens: 2000,\n  temperature: 0,\n  messages: [\n    {\n      role: 'user',\n      content: `Si asistent na extrakciu √∫dajov z lek√°rskych spr√°v detskej oƒçnej kliniky Eyekido. Z nasleduj√∫ceho textu lek√°rskej spr√°vy extrahuj √∫daje vo form√°te JSON. V≈ΩDY odpovedz IBA platn√Ωm JSON objektom, bez ≈æiadneho ƒèal≈°ieho textu, bez markdown blokov, bez vysvetlen√≠.\n\nExtrahuj tieto polia:\n- meno_dietata: cel√© meno die≈•a≈•a\n- datum_narodenia: d√°tum narodenia\n- rodne_cislo: rodn√© ƒç√≠slo (len ƒç√≠sla, bez lomky)\n- meno_rodica: cel√© meno rodiƒça\n- email_rodica: email rodiƒça\n- datum_vysetrenia: d√°tum posledn√©ho vy≈°etrenia (ak nie je uveden√Ω, pou≈æi d√°tum dokumentu)\n- diagnoza: text diagn√≥zy\n- odporucania: cel√Ω text odpor√∫ƒçan√≠ lek√°rky (vr√°tane v≈°etk√Ωch detailov)\n- doporucena_kontrola: text doporuƒçenej kontroly\n- lekar: meno lek√°ra/lek√°rky\n\nText lek√°rskej spr√°vy:\n${text}`\n    }\n  ]\n};\n\nreturn [{ json: requestBody }];"
      },
      "id": "a1b2c3d4-0030-4000-8000-000000000030",
      "name": "Code - Build AI Request",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [720, 300]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.anthropic.com/v1/messages",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "anthropicApi",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "anthropic-version",
              "value": "2023-06-01"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify($json) }}",
        "options": {}
      },
      "id": "a1b2c3d4-0004-4000-8000-000000000004",
      "name": "HTTP Request - AI Extract Data",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [920, 300],
      "credentials": {
        "anthropicApi": {
          "id": "",
          "name": "Anthropic API"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Parse AI response and extract structured data\nconst response = $input.first().json;\nlet responseText = '';\n\nif (response.content && Array.isArray(response.content)) {\n  responseText = response.content\n    .filter(block => block.type === 'text')\n    .map(block => block.text)\n    .join('');\n} else {\n  throw new Error('Unexpected AI response format: ' + JSON.stringify(response).substring(0, 300));\n}\n\n// Clean markdown code blocks\nresponseText = responseText.replace(/```json\\n?/g, '').replace(/```\\n?/g, '').trim();\n\n// Parse JSON\nlet data;\ntry {\n  data = JSON.parse(responseText);\n} catch(e) {\n  const jsonMatch = responseText.match(/\\{[\\s\\S]*\\}/);\n  if (jsonMatch) {\n    data = JSON.parse(jsonMatch[0]);\n  } else {\n    throw new Error('Failed to parse JSON: ' + responseText.substring(0, 300));\n  }\n}\n\n// Last 4 digits of birth number = password\nconst rc = String(data.rodne_cislo || '').replace(/\\//g, '').replace(/\\s/g, '');\nconst heslo = rc.slice(-4);\n\nif (!heslo || heslo.length !== 4) {\n  throw new Error('Failed to extract password from birth number: ' + rc);\n}\n\n// First name of parent for greeting\nconst menoRodica = data.meno_rodica || '';\nconst krstneMeno = menoRodica.split(' ')[0] || menoRodica;\n\nreturn [{\n  json: {\n    ...data,\n    heslo_pdf: heslo,\n    krstne_meno_rodica: krstneMeno\n  }\n}];"
      },
      "id": "a1b2c3d4-0005-4000-8000-000000000005",
      "name": "Code - Parse Extracted Data",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1120, 300]
    },
    {
      "parameters": {
        "jsCode": "// Build Anthropic API request for rewriting recommendations\nconst data = $input.first().json;\n\nconst requestBody = {\n  model: 'claude-sonnet-4-20250514',\n  max_tokens: 1500,\n  temperature: 0.3,\n  messages: [\n    {\n      role: 'user',\n      content: `Si priateƒæsk√° asistentka detskej oƒçnej kliniky Eyekido. Preformuluj nasleduj√∫ce lek√°rske odpor√∫ƒçania do zrozumiteƒænej formy pre rodiƒça. Pou≈æi jednoduch√Ω, ƒæudsk√Ω jazyk bez odborn√Ωch term√≠nov (ale zachovaj podstatu a v≈°etky konkr√©tne in≈°trukcie). Nepou≈æ√≠vaj odr√°≈æky ani form√°tovanie - p√≠≈° plynul√Ωm textom, prehƒæadne, v kr√°tkych odsekoch. P√≠≈° v slovenƒçine. Neprid√°vaj ≈æiadny √∫vod ani z√°ver, len preformulovan√© odpor√∫ƒçania.\n\nOrigin√°lne odpor√∫ƒçania lek√°rky:\n${data.odporucania || ''}\n\nDiagn√≥za:\n${data.diagnoza || ''}\n\nDoporuƒçen√° kontrola:\n${data.doporucena_kontrola || ''}`\n    }\n  ]\n};\n\nreturn [{ json: { ...data, requestBody } }];"
      },
      "id": "a1b2c3d4-0031-4000-8000-000000000031",
      "name": "Code - Build Rewrite Request",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1320, 300]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.anthropic.com/v1/messages",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "anthropicApi",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "anthropic-version",
              "value": "2023-06-01"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify($json.requestBody) }}",
        "options": {}
      },
      "id": "a1b2c3d4-0006-4000-8000-000000000006",
      "name": "HTTP Request - AI Rewrite Recommendations",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1520, 300],
      "credentials": {
        "anthropicApi": {
          "id": "",
          "name": "Anthropic API"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Merge rewritten recommendations with data\nconst previousData = $('Code - Build Rewrite Request').first().json;\nconst aiResponse = $input.first().json;\n\nlet odporucania_preformulovane = '';\nif (aiResponse.content && Array.isArray(aiResponse.content)) {\n  odporucania_preformulovane = aiResponse.content\n    .filter(block => block.type === 'text')\n    .map(block => block.text)\n    .join('');\n}\n\n// Replace newlines with <br> for HTML email\nconst odporucania_html = odporucania_preformulovane\n  .replace(/\\n\\n/g, '</p><p style=\"font-size: 15px; line-height: 1.8; color: #444; margin: 8px 0;\">')\n  .replace(/\\n/g, '<br>');\n\n// Remove requestBody from output\nconst { requestBody, ...cleanData } = previousData;\n\nreturn [{\n  json: {\n    ...cleanData,\n    odporucania_preformulovane,\n    odporucania_html\n  }\n}];"
      },
      "id": "a1b2c3d4-0007-4000-8000-000000000007",
      "name": "Code - Merge Data",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1720, 300]
    },
    {
      "parameters": {
        "jsCode": "// Prepare PDF base64 and password for Cloud Function\nconst pdfBinary = $('Google Drive - Download PDF').first().binary;\nconst data = $input.first().json;\n\nconst binaryKey = Object.keys(pdfBinary)[0];\nconst pdfBase64 = pdfBinary[binaryKey]?.data || '';\n\nif (!pdfBase64) {\n  throw new Error('Failed to get PDF data');\n}\n\nreturn [{\n  json: {\n    ...data,\n    pdf_base64: pdfBase64,\n    password: data.heslo_pdf\n  }\n}];"
      },
      "id": "a1b2c3d4-0008-4000-8000-000000000008",
      "name": "Code - Prepare for Cloud Function",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1920, 300]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://encrypt-pdf-1019076505003.europe-west1.run.app",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({ pdf_base64: $json.pdf_base64, password: $json.password }) }}",
        "options": {
          "timeout": 30000
        }
      },
      "id": "a1b2c3d4-0009-4000-8000-000000000009",
      "name": "HTTP Request - Encrypt PDF",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [2120, 300]
    },
    {
      "parameters": {
        "jsCode": "// Convert encrypted PDF to binary attachment for Gmail\nconst encryptedResponse = $input.first().json;\nconst data = $('Code - Merge Data').first().json;\n\nif (!encryptedResponse.success) {\n  throw new Error('Cloud Function failed: ' + (encryptedResponse.error || 'unknown error'));\n}\n\nconst encryptedBase64 = encryptedResponse.encrypted_pdf_base64;\nconst fileName = `Lekarska_sprava_${data.meno_dietata.replace(/\\s+/g, '_')}.pdf`;\n\nreturn [{\n  json: {\n    email_rodica: data.email_rodica,\n    krstne_meno_rodica: data.krstne_meno_rodica,\n    meno_dietata: data.meno_dietata,\n    datum_vysetrenia: data.datum_vysetrenia,\n    odporucania_html: data.odporucania_html,\n    fileName\n  },\n  binary: {\n    data: {\n      data: encryptedBase64,\n      mimeType: 'application/pdf',\n      fileName: fileName\n    }\n  }\n}];"
      },
      "id": "a1b2c3d4-0010-4000-8000-000000000010",
      "name": "Code - Prepare Attachment",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [2320, 300]
    },
    {
      "parameters": {
        "sendTo": "={{ $json.email_rodica }}",
        "subject": "=Lek√°rska spr√°va z vy≈°etrenia ‚Äî {{ $json.meno_dietata }} | Eyekido",
        "emailType": "html",
        "message": "=<div style=\"font-family: 'Segoe UI', Arial, sans-serif; max-width: 600px; margin: 0 auto; color: #333;\">\n\n  <!-- HEADER -->\n  <div style=\"background-color: #f8f9fa; padding: 24px; border-radius: 8px 8px 0 0; text-align: center;\">\n    <h1 style=\"color: #1a1a1a; margin: 0; font-size: 28px; font-weight: 800; letter-spacing: -0.5px;\">eyekido</h1>\n    <p style=\"color: #888; margin: 6px 0 0 0; font-size: 13px;\">Oƒçn√© centrum pre deti</p>\n  </div>\n\n  <!-- BODY -->\n  <div style=\"padding: 32px 24px; background-color: #ffffff; border: 1px solid #e9ecef; border-top: none;\">\n\n    <p style=\"font-size: 16px; line-height: 1.6; margin-top: 0;\">Mil√° <strong>{{ $json.krstne_meno_rodica }}</strong>,</p>\n\n    <p style=\"font-size: 16px; line-height: 1.6;\">\n      ƒèakujeme za n√°v≈°tevu n√°≈°ho centra. V pr√≠lohe V√°m posielame lek√°rsku spr√°vu\n      z vy≈°etrenia <strong>{{ $json.meno_dietata }}</strong> zo d≈àa <strong>{{ $json.datum_vysetrenia }}</strong>.\n    </p>\n\n    <!-- HESLO BOX -->\n    <div style=\"background-color: #fff8e1; border: 1px solid #ffe082; border-radius: 8px; padding: 16px 20px; margin: 24px 0;\">\n      <p style=\"margin: 0 0 8px 0; font-size: 14px; color: #6d4c00;\">üîí <strong>PDF s√∫bor je zaheslovan√Ω.</strong></p>\n      <p style=\"margin: 0; font-size: 14px; color: #6d4c00;\">Heslo s√∫ posledn√© 4 ƒç√≠slice rodn√©ho ƒç√≠sla V√°≈°ho die≈•a≈•a.</p>\n    </div>\n\n    <!-- ODPOR√öƒåANIA -->\n    <div style=\"background-color: #f0f7ff; border-left: 4px solid #4a90d9; padding: 20px 24px; margin: 28px 0; border-radius: 0 8px 8px 0;\">\n      <h3 style=\"color: #2c3e50; margin: 0 0 12px 0; font-size: 16px;\">üìã Odpor√∫ƒçania lek√°rky</h3>\n      <p style=\"font-size: 15px; line-height: 1.8; color: #444; margin: 0;\">\n        {{ $json.odporucania_html }}\n      </p>\n    </div>\n\n    <p style=\"font-size: 15px; line-height: 1.6; color: #555;\">\n      Ak m√°te ak√©koƒævek ot√°zky, nev√°hajte n√°s kontaktova≈•.\n    </p>\n\n    <p style=\"font-size: 15px; line-height: 1.6; margin-bottom: 0;\">\n      S pozdravom,<br>\n      <strong>T√≠m Eyekido</strong>\n    </p>\n\n  </div>\n\n  <!-- FOOTER -->\n  <div style=\"background-color: #2c3e50; padding: 24px; border-radius: 0 0 8px 8px; text-align: center; color: #ffffff;\">\n    <p style=\"margin: 0 0 6px 0; font-size: 15px; font-weight: 600;\">Eyekido ‚Äî Oƒçn√© centrum pre deti</p>\n    <p style=\"margin: 0 0 4px 0; font-size: 13px; color: #bdc3c7;\">Sv√§toplukova 2A, 821 08 Bratislava</p>\n    <p style=\"margin: 0 0 4px 0; font-size: 13px; color: #bdc3c7;\">üìû +421 911 333 583</p>\n    <p style=\"margin: 0; font-size: 13px;\">\n      <a href=\"https://www.eyekido.sk\" style=\"color: #5dade2; text-decoration: none;\">www.eyekido.sk</a>\n      &nbsp;¬∑&nbsp;\n      <a href=\"https://www.instagram.com/eye.kido\" style=\"color: #5dade2; text-decoration: none;\">@eye.kido</a>\n    </p>\n  </div>\n\n</div>",
        "options": {
          "appendAttribution": false,
          "attachmentsUi": {
            "attachmentsBinary": [
              {
                "property": "data"
              }
            ]
          }
        }
      },
      "id": "a1b2c3d4-0011-4000-8000-000000000011",
      "name": "Gmail - Send Email",
      "type": "n8n-nodes-base.gmail",
      "typeVersion": 2.1,
      "position": [2520, 300],
      "credentials": {
        "gmailOAuth2": {
          "id": "",
          "name": "Gmail - vysetrenie@eyekido.sk"
        }
      }
    }
  ],
  "connections": {
    "Google Drive Trigger": {
      "main": [
        [
          {
            "node": "Google Drive - Download PDF",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Google Drive - Download PDF": {
      "main": [
        [
          {
            "node": "Extract From File",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract From File": {
      "main": [
        [
          {
            "node": "Code - Build AI Request",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code - Build AI Request": {
      "main": [
        [
          {
            "node": "HTTP Request - AI Extract Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Request - AI Extract Data": {
      "main": [
        [
          {
            "node": "Code - Parse Extracted Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code - Parse Extracted Data": {
      "main": [
        [
          {
            "node": "Code - Build Rewrite Request",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code - Build Rewrite Request": {
      "main": [
        [
          {
            "node": "HTTP Request - AI Rewrite Recommendations",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Request - AI Rewrite Recommendations": {
      "main": [
        [
          {
            "node": "Code - Merge Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code - Merge Data": {
      "main": [
        [
          {
            "node": "Code - Prepare for Cloud Function",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code - Prepare for Cloud Function": {
      "main": [
        [
          {
            "node": "HTTP Request - Encrypt PDF",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Request - Encrypt PDF": {
      "main": [
        [
          {
            "node": "Code - Prepare Attachment",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code - Prepare Attachment": {
      "main": [
        [
          {
            "node": "Gmail - Send Email",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "tags": [],
  "pinData": {},
  "versionId": "5"
}
